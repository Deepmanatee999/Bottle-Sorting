<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bottle Sorting System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
    body { font-family: Arial; padding: 0; margin:0; background:#f4f6fa; }
    header { background:#2563eb; padding:12px 18px; color:#fff; display:flex;
      justify-content: space-between; align-items:center; }
    nav button { margin-left:8px; padding:6px 12px; border:none; border-radius:6px;
      cursor:pointer; background:#fff2; color:#fff; }
    nav button.active { background:#fff; color:#2563eb; }

    .card {
      width:90%; max-width:450px; margin:20px auto; padding:20px; background:#fff;
      border-radius:10px; box-shadow:0 4px 10px #0002;
    }
    input { width:100%; padding:10px; margin-top:8px;
       border:1px solid #ccc; border-radius:6px; }
    button.primary {
       width:100%; padding:10px; background:#2563eb; color:#fff;
       border:none; border-radius:6px; margin-top:12px; cursor:pointer;
    }
    .hidden { display:none; }
    .stat-box { background:#f9fafb; padding:12px; border-radius:8px; margin-top:8px; }
</style>
</head>

<body>

<header>
  <h2>♻️ Bottle Sorting</h2>
  <nav>
    <button id="btnLogin" class="active" onclick="showPage('login')">Login</button>
    <button id="btnRegister" onclick="showPage('register')">Register</button>
    <button id="btnDashboard" onclick="showPage('dashboard')">Dashboard</button>
    <button id="btnChange" onclick="showPage('change')">Change Point</button>
    <button id="btnLogout" onclick="logout()" style="display:none;">Logout</button>
  </nav>
</header>

<div id="msg" style="text-align:center; color:red; margin-top:10px;"></div>

<!-- LOGIN -->
<div id="login" class="card">
  <h3>Login</h3>
  <input id="loginPhone" placeholder="Phone number (ex. 0931234567)">
  <input id="loginPass" type="password" placeholder="Password">
  <button class="primary" onclick="doLogin()">Login</button>
</div>

<!-- REGISTER -->
<div id="register" class="card hidden">
  <h3>Register</h3>
  <input id="regFirst" placeholder="First Name">
  <input id="regLast" placeholder="Last Name">
  <input id="regPhone" placeholder="Phone Number (ex. 0931234567)">
  <input id="regPass" type="password" placeholder="Password (min 6 chars)">
  <button class="primary" onclick="doRegister()">Register</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="card hidden">
  <h3>Dashboard</h3>

  <label>Full Name</label>
  <input id="dbName" disabled>

  <label>Phone</label>
  <input id="dbPhone" disabled>

  <label>Total Points</label>
  <input id="dbPoints" disabled>

  <div class="stat-box">
    <b>Plastic Bottle</b><br>
    Count: <span id="plasticCount">0</span>  
    <button class="primary" onclick="addBottle('plastic')">+1 Plastic</button>
  </div>

  <div class="stat-box">
    <b>Glass Bottle</b><br>
    Count: <span id="glassCount">0</span>
    <button class="primary" onclick="addBottle('glass')">+1 Glass</button>
  </div>

  <div class="stat-box">
    <b>Aluminium Can</b><br>
    Count: <span id="alCount">0</span>
    <button class="primary" onclick="addBottle('al')">+1 Aluminium</button>
  </div>
</div>

<!-- CHANGE POINT -->
<div id="change" class="card hidden">
  <h3>Change Point → Money</h3>
  <input id="curPoints" disabled>
  <input id="redeemPoint" type="number" placeholder="Points to redeem">
  <input id="redeemPrompt" placeholder="PromptPay ID">
  <button class="primary" onclick="redeem()">Redeem</button>
</div>

<script>
// ------------------------------------------------
// Firebase Init
// ------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyDHFWASPvDnldxouO9nokECom43qKhCjKQ",
  authDomain: "bottle-sorting.firebaseapp.com",
  projectId: "bottle-sorting",
  storageBucket: "bottle-sorting.firebasestorage.app",
  messagingSenderId: "408690983994",
  appId: "1:408690983994:web:2a39242b45e8ca29062103",
  measurementId: "G-2PS2FXXVKT"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ------------------------------------------------
// UI helper
// ------------------------------------------------
function showPage(p) {
  ["login","register","dashboard","change"].forEach(id=>{
    document.getElementById(id).classList.add("hidden");
    document.getElementById("btn"+id.charAt(0).toUpperCase()+id.slice(1)).classList.remove("active");
  });
  document.getElementById(p).classList.remove("hidden");
  document.getElementById("btn"+p.charAt(0).toUpperCase()+p.slice(1)).classList.add("active");
}

function showMsg(t,color="red") {
  const m = document.getElementById("msg");
  m.style.color = color;
  m.innerText = t;
}

// ------------------------------------------------
// Convert phone to email
// ------------------------------------------------
function phoneToEmail(phone) {
  return phone + "@phone.local";
}

// ------------------------------------------------
// Authentication
// ------------------------------------------------
async function doRegister() {
  let f = regFirst.value.trim();
  let l = regLast.value.trim();
  let p = regPhone.value.trim();
  let pass = regPass.value;

  if (!f || !l || !p || !pass) return showMsg("กรอกข้อมูลให้ครบ");
  if (pass.length < 6) return showMsg("Password ต้องมากกว่า 6 ตัว");

  let email = phoneToEmail(p);

  try {
    await auth.createUserWithEmailAndPassword(email, pass);
    await db.collection("users").doc(auth.currentUser.uid).set({
      firstName: f,
      lastName: l,
      phone: p,
      bottles: { plastic:0, glass:0, al:0 },
      points: 0
    });
    showMsg("Register สำเร็จ!", "green");
    showPage("login");
  } catch(e) {
    showMsg(e.message);
  }
}

async function doLogin() {
  let p = loginPhone.value.trim();
  let pass = loginPass.value;
  if (!p || !pass) return showMsg("กรอกเบอร์และรหัสผ่าน");

  let email = phoneToEmail(p);

  try {
    await auth.signInWithEmailAndPassword(email, pass);
    showMsg("Login สำเร็จ!", "green");
  } catch(e) {
    showMsg("Login ไม่สำเร็จ: " + e.message);
  }
}

function logout() {
  auth.signOut();
  showMsg("Logout สำเร็จ", "green");
  showPage("login");
  btnLogout.style.display = "none";
}

// ------------------------------------------------
// Auth State
// ------------------------------------------------
auth.onAuthStateChanged(async user => {
  if (user) {
    btnLogout.style.display = "inline-block";
    loadUserData();
    showPage("dashboard");
  }
});

// ------------------------------------------------
// Load user data
// ------------------------------------------------
let userData = null;

async function loadUserData() {
  const doc = await db.collection("users").doc(auth.currentUser.uid).get();
  userData = doc.data();

  dbName.value = userData.firstName + " " + userData.lastName;
  dbPhone.value = userData.phone;
  dbPoints.value = userData.points;
  plasticCount.innerText = userData.bottles.plastic;
  glassCount.innerText = userData.bottles.glass;
  alCount.innerText = userData.bottles.al;
  curPoints.value = userData.points;
}

// ------------------------------------------------
// Add bottle
// ------------------------------------------------
const POINT_PLASTIC = 12;
const POINT_GLASS = 6;
const POINT_AL = 50;

async function addBottle(type) {
  userData.bottles[type]++;
  userData.points =
    userData.bottles.plastic * POINT_PLASTIC +
    userData.bottles.glass * POINT_GLASS +
    userData.bottles.al * POINT_AL;

  await db.collection("users").doc(auth.currentUser.uid).set(userData);

  loadUserData();
  showMsg("เพิ่ม " + type + " สำเร็จ", "green");
}

// ------------------------------------------------
// Redeem points
// ------------------------------------------------
async function redeem() {
  let use = parseInt(redeemPoint.value);
  let prompt = redeemPrompt.value.trim();

  if (!use || !prompt) return showMsg("กรอกข้อมูลให้ครบ");
  if (use > userData.points) return showMsg("คะแนนไม่พอ");

  userData.points -= use;
  await db.collection("users").doc(auth.currentUser.uid).set(userData);

  await db.collection("redeem").add({
    uid: auth.currentUser.uid,
    points: use,
    promptpay: prompt,
    status: "pending",
    created: firebase.firestore.FieldValue.serverTimestamp()
  });

  showMsg("ส่งคำขอแลกคะแนนสำเร็จ!", "green");
  loadUserData();
}
</script>
</body>
</html>
